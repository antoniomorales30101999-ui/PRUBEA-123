<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RED TECAMAC - Sistema Integral</title>

    <script>
        var claveCorrecta = "Tecamac2026*";
        if (sessionStorage.getItem("acceso_permitido") !== "true") {
            var intento = prompt("üîê ACCESO RESTRINGIDO\nIngrese clave:");
            if (intento === claveCorrecta) { sessionStorage.setItem("acceso_permitido", "true"); }
            else { window.location.href = "https://google.com"; }
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; color: #e8e8e8; font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; }
        .app-header { background: linear-gradient(135deg, #00d4ff 0%, #0077b6 50%, #004a99 100%); color: white; padding: 30px 20px; text-align: center; box-shadow: 0 4px 30px rgba(0, 212, 255, 0.3); position: relative; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        /* Pesta√±as */
        .nav-tabs-custom { display: flex; gap: 10px; margin-bottom: 25px; justify-content: center; }
        .tab-btn { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(0, 212, 255, 0.3); color: #ccc; padding: 15px 35px; border-radius: 50px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .tab-btn.active { background: linear-gradient(135deg, #00d4ff, #0077b6); border-color: #00d4ff; color: white; box-shadow: 0 5px 25px rgba(0, 212, 255, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        
        /* Buscador */
        .search-wrapper { max-width: 700px; margin: 0 auto 30px auto; }
        #mainSearch { background: rgba(255, 255, 255, 0.95); border: none; border-radius: 50px !important; padding: 20px 30px !important; width: 100% !important; font-size: 1.1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.3); outline: none; color: #333; }
        
        /* Panel de An√°lisis */
        .analysis-panel { background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .paste-area { background: rgba(0, 0, 0, 0.3); border: 2px dashed rgba(0, 212, 255, 0.5); border-radius: 15px; padding: 20px; min-height: 200px; color: #ccc; width: 100%; outline: none; }
        
        /* Estad√≠sticas */
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: rgba(255, 255, 255, 0.08); border-radius: 15px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-card .number { font-size: 2.5rem; font-weight: 700; color: #00d4ff; }

        /* Contenedores de Tablas */
        #contenedorTabla, #contenedorResultados { background: white; border-radius: 20px; padding: 20px; color: #333; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .table thead th { background: #004a99 !important; color: white !important; }

        /* COLORES SOLICITADOS */
        .fila-cancelada { background-color: #ffcccc !important; color: #990000 !important; font-weight: 500; }
        .fila-inactiva { background-color: #e2e8f0 !important; color: #475569 !important; }
        .not-found { background-color: #fee2e2 !important; color: #dc2626 !important; }

        .qr-badge { padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
        .qr-hot { background: #ff416c; color: white; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>

<body>

    <div class="app-header">
        <h1>üõ∞Ô∏è SISTEMA CORE TECAMAC</h1>
        <p>B√∫squeda y An√°lisis de Afectaciones Masivas</p>
    </div>

    <div class="main-container">

        <div class="nav-tabs-custom">
            <button class="tab-btn active" data-tab="busqueda">üîç B√∫squeda Individual</button>
            <button class="tab-btn" data-tab="analisis">üìä An√°lisis Masivo</button>
        </div>

        <div id="tab-busqueda" class="tab-content active">
            <div class="search-wrapper">
                <input type="text" id="mainSearch" placeholder="üîç Buscar por Cuenta, QR u OLT...">
            </div>
            <div id="contenedorTabla">
                <table id="tablaMaestra" class="table table-hover w-100">
                    <thead>
                        <tr>
                            <th>Cuenta</th> <th>QR</th> <th>OLT</th> <th>FSP</th> <th>Lat</th> <th>Lon</th> <th>Ubicaci√≥n</th> <th>Puerto N2</th> <th>Estatus</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>

        <div id="tab-analisis" class="tab-content">
            <div class="analysis-panel">
                <textarea id="pasteArea" class="paste-area" placeholder="Pega aqu√≠ los datos del OLT..."></textarea>
                <div class="text-center mt-3">
                    <button class="btn btn-primary btn-lg rounded-pill px-5" onclick="analizarDatos()">üîé Analizar Afectaci√≥n</button>
                    <button class="btn btn-outline-light btn-lg rounded-pill px-5" onclick="limpiarAnalisis()">üóëÔ∏è Limpiar</button>
                </div>
            </div>

            <div id="resultadosAnalisis" class="mt-4" style="display:none;">
                <div class="stats-cards">
                    <div class="stat-card"><div class="number" id="statTotal">0</div><div class="label">Total</div></div>
                    <div class="stat-card"><div class="number" id="statEncontrados">0</div><div class="label">Encontrados</div></div>
                    <div class="stat-card"><div class="number" id="statQRs">0</div><div class="label">QRs √önicos</div></div>
                </div>
                <div id="contenedorResultados">
                    <table id="tablaResultados" class="table table-hover w-100">
                        <thead>
                            <tr>
                                <th>Cuenta</th> <th>QR</th> <th>OLT</th> <th>FSP</th> <th>Estatus</th> <th>Clientes en QR</th>
                            </tr>
                        </thead>
                        <tbody id="bodyResultados"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        $.fn.dataTable.ext.errMode = 'none'; // SEGURO ANTI-AVISOS
        
        var table;
        var tableResultados;
        var datosCSV = [];
        var datosIndexados = {};

        $(document).ready(function () {
            // Manejo de pesta√±as
            $('.tab-btn').on('click', function () {
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                $('.tab-content').removeClass('active');
                $('#tab-' + $(this).data('tab')).addClass('active');
            });

            // Cargar datos
            Papa.parse("datos.csv", {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function (results) {
                    datosCSV = results.data.slice(1);

                    // Indexar para b√∫squeda r√°pida en An√°lisis Masivo
                    datosCSV.forEach(function(row) {
                        if(row[0]) {
                            var cuenta = row[0].replace(/[^0-9]/g, '');
                            datosIndexados[cuenta] = row;
                        }
                    });

                    table = $('#tablaMaestra').DataTable({
                        data: datosCSV,
                        dom: 'rtip',
                        pageLength: 20,
                        columnDefs: [{ targets: 8, defaultContent: "ACTIVA" }],
                        createdRow: function(row, data, dataIndex) {
                            var estatus = (data[8] || "").toUpperCase().trim();
                            if (estatus === "CANCELADA") $(row).addClass('fila-cancelada');
                            else if (estatus === "INACTIVA") $(row).addClass('fila-inactiva');
                        }
                    });

                    $('#mainSearch').on('keyup', function () { table.search(this.value).draw(); });
                }
            });
        });

        function analizarDatos() {
            var texto = $('#pasteArea').val();
            if (!texto.trim()) return;

            // Extraer n√∫meros de 10 d√≠gitos (cuentas)
            var cuentas = texto.match(/\b\d{10}\b/g) || [];
            cuentas = [...new Set(cuentas)]; // √önicos

            var html = '';
            var encontrados = 0;
            var qrsConteo = {};

            // Primero contamos QRs
            cuentas.forEach(c => {
                var d = datosIndexados[c];
                if(d) {
                    var qr = d[1] || 'N/A';
                    qrsConteo[qr] = (qrsConteo[qr] || 0) + 1;
                }
            });

            // Generamos filas
            cuentas.forEach(c => {
                var d = datosIndexados[c];
                if(d) {
                    encontrados++;
                    var est = (d[8] || "ACTIVA").toUpperCase();
                    var cl = est === "CANCELADA" ? "fila-cancelada" : (est === "INACTIVA" ? "fila-inactiva" : "");
                    
                    html += `<tr class="${cl}">
                        <td>${c}</td>
                        <td><span class="qr-badge ${qrsConteo[d[1]] > 3 ? 'qr-hot' : ''}">${d[1]}</span></td>
                        <td>${d[2]}</td>
                        <td>${d[3]}</td>
                        <td>${est}</td>
                        <td><strong>${qrsConteo[d[1]]}</strong></td>
                    </tr>`;
                } else {
                    html += `<tr class="not-found"><td>${c}</td><td colspan="5">NO ENCONTRADO EN BASE</td></tr>`;
                }
            });

            if (tableResultados) tableResultados.destroy();
            $('#bodyResultados').html(html);
            $('#resultadosAnalisis').show();
            $('#statTotal').text(cuentas.length);
            $('#statEncontrados').text(encontrados);
            $('#statQRs').text(Object.keys(qrsConteo).length);
            
            tableResultados = $('#tablaResultados').DataTable({ dom: 'rtip', pageLength: 50 });
        }

        function limpiarAnalisis() {
            $('#pasteArea').val('');
            $('#resultadosAnalisis').hide();
        }
    </script>
</body>
</html>
